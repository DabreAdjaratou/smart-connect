<style>
    .bluebox, .dashboard-stat2{
        border:1px solid #3598DC;
    }
</style>
<?php
$sType = '';
foreach($sampleType as $samples){
    $sType.='<option value="'.base64_encode($samples['sample_id']).'">'.ucwords($samples['sample_name']).'</option>';
}
?>
                    <!-- BEGIN PAGE BAR -->
                    <!-- BEGIN PAGE BAR -->
                    <div class="page-bar">
                        <ul class="page-breadcrumb">
                            <li>
                                <a href="/">Labs Dashboard</a>
                            </li>
                        </ul>
                    </div>

                    <!-- END PAGE BAR -->
                    <!-- BEGIN PAGE TITLE-->
                    
                    <br>
                    <br>
                    
                    <!-- END PAGE TITLE-->
                    <!-- END PAGE HEADER-->
                    <div class="row" style="padding-top:10px;padding-bottom:20px;">
                        <div class="col-lg-6">
                            <div id="dashboard-report-range" class="btn btn-sm form-control"
                                 data-container="body"
                                 data-placement="bottom"
                                 data-original-title="Change dashboard date range">
                                        DATE RANGE&nbsp;&nbsp;&nbsp;&nbsp;<i class="icon-calendar"></i>&nbsp;
                                        <span class="thin uppercase hidden-xs"></span>&nbsp;
                                        <i class="fa fa-angle-down"></i>
                                        <input type="hidden" name="sampleCollectionDate" id="sampleCollectionDate" />
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <select name="labName" id="labName" class="form-control" title="Please choose lab name">
                                <option value="">-- Lab Name --</option>
                                <?php
                                foreach($labName as $lab)
                                {
                                    ?>
                                    <option value="<?php echo base64_encode($lab['facility_id']);?>"><?php echo $lab['facility_name'];?></option>
                                    <?php
                                }
                                ?>
                                
                            </select>
                        </div>
                        <div class="col-lg-3">
                                <a href="javascript:void(0);" class="btn btn-info btn-sm" onclick="getEverything()">Submit</a>
                            </div>
                    </div>
                    <div class="row">
                        <div id="sampleResultDetails"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-sm-6">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption ">
                                        <span class="caption-subject">Samples Tested</span>
                                    </div>
                                    <div class="actions">
                                        <div class="btn-group">
                                            <select id="sampleType" class="fetchAll btn white btn-outline btn-circle btn-sm dropdown-toggle">
                                                <option value="">All Sample Types</option>
                                                <?php echo $sType;?>
                                            </select>
                                        </div>
                                    </div>                                    
                                    
                                </div>
                                <div class="portlet-body" style="cursor:pointer;" onclick="document.location.href='/labs/samples-tested'">
                                    <div id="samplesTestedResult"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 col-sm-6">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption ">
                                        <span class="caption-subject">Samples Tested based on Volume</span>
                                    </div>
                                    <div class="actions">
                                        <div class="btn-group">
                                            <select id="sampleTypeVolume" class="fetchAll btn white btn-outline btn-circle btn-sm dropdown-toggle">
                                                <option value="">All Sample Types</option>
                                                <?php echo $sType;?>
                                            </select>
                                        </div>
                                    </div>                                    
                                </div>
                                <div class="portlet-body" style="cursor:pointer;" onclick="document.location.href='/labs/samples-tested'">
                                    <div id="facilitiesTestedValue"></div>
                                </div>
                            </div>
                        </div>                        
                        
                    </div>
                    <div class="row">
                        <div class="col-md-4 col-sm-4">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption ">
                                        <span class="caption-subject">Laboratory Turnaround Time</span>
                                    </div>
                                </div>
                                <div class="portlet-body">
                                    <div id="labAverageTat"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <span class="caption-subject">Requisition Forms for Testing</span>
                                    </div>
                                </div>
                                <div class="portlet-body" id="requisitionForms">
                                    
                                </div>
                            </div>                            
                            
                            
                        </div>
                        <div class="col-md-4 col-sm-4">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <span class="caption-subject">Sample Volume</span>
                                    </div>
                                    <div class="actions">
                                        <div class="btn-group">
                                            <select id="sampleVolume" class="fetchAll btn white btn-outline btn-circle btn-sm dropdown-toggle">
                                                <option value="">All Sample Types</option>
                                                <?php echo $sType;?>
                                            </select>
                                        </div>
                                    </div>                                    
                                </div>
                                <div class="portlet-body" id="pieChartLabResult">
                                </div>
                            </div>                            
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption ">
                                        <span class="caption-subject">Facilities</span>
                                    </div>
                                </div>                                
                                <div class="portlet-body">
                                    <div id="controls-polyline"></div>
                                    <div id="gmap-polyline-data"  ></div>
                                    
                                </div>
                            </div>
                        </div>                        
                    </div>
        
        <script src="https://maps.google.com/maps/api/js?libraries=geometry&v=3&key=AIzaSyAFpbfAKFJZ8Ps7yAGIDZtD4EeBlsb_ANA"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>
        <script src="<?php echo $this->basePath('assets/pages/scripts/dashboard.js'); ?>" type="text/javascript"></script>
        <script src="<?php echo $this->basePath('assets/global/scripts/maplace.min.js'); ?>"></script>
        
        
        <script>
            
            var gfxPath = 'https://raw.githubusercontent.com/highslide-software/pattern-fill/master/graphics/';
            var dpicker = "";
            var startDate;
            var endDate;

            
        function getSampleResult()
        {
            dateRange = $("#sampleCollectionDate").val();
            facilityId = $("#labName").val();
        $.post("<?php echo $this->url('laboratory', array('action' => 'get-sample-result')); ?>",{sampleCollectionDate:dateRange,facilityId:facilityId},
        function(data) {
            $("#sampleResultDetails").html(data);
        });
        }
        function getTestedSampleResult()
        {
            sampleType = $("#sampleType").val();
            dateRange = $("#sampleCollectionDate").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-sample-test-result')); ?>",{sampleCollectionDate:dateRange,sampleType:sampleType,facilityId:facilityId},
            function(data) {
                $("#samplesTestedResult").html(data);
            });
        }
        function getTestedSampleResultBasedVolume()
        {
            sampleType = $("#sampleTypeVolume").val();
            dateRange = $("#sampleCollectionDate").val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-sample-test-result-volume')); ?>",{sampleCollectionDate:dateRange,sampleType:sampleType,facilityId:facilityId,facilityId:facilityId},
            function(data) {
                $("#facilitiesTestedValue").html(data);
            });
        }
        function getRequisitionFormsTested()
        {
            dateRange = $("#sampleCollectionDate").val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-requisition-forms')); ?>",{sampleCollectionDate:dateRange,facilityId:facilityId},
            function(data) {
            $("#requisitionForms").html(data);
            });
        }
        function getSampleVolume()
        {
            dateRange = $("#sampleCollectionDate").val();
            sampleType = $("#sampleVolume").val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-sample-volume')); ?>",{sampleCollectionDate:dateRange,sampleType:sampleType,facilityId:facilityId},
            function(data) {
            $("#pieChartLabResult").html(data);
            });
        }
        function getLabTime()
        {
            dateRange = $("#sampleCollectionDate").val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-lab-turn-around-time')); ?>",{sampleCollectionDate:dateRange,facilityId:facilityId},
            function(data) {
            $("#labAverageTat").html(data);
            });
        }
        function getLabFacilities()
        {
            dateRange = $("#sampleCollectionDate").val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-lab-facilities')); ?>",{sampleCollectionDate:dateRange,facilityId:facilityId},
            function(data) {
            $("#gmap-polyline-data").html(data);
            });
        }
            
            $(function () {
                
                $.blockUI.defaults.css.border = '1px solid grey'; 
                $(document).ajaxStart($.blockUI({ message: '<h2>Processing...</h2>' })).ajaxStop($.unblockUI);
                

                $(".fetchAll").on("change", function(){
                    getEverything();
                });
                
                dpicker = $('#dashboard-report-range').daterangepicker({
                "ranges": {'Last 60 Days':[moment().subtract('days',59),moment()],'Last 90 Days':[moment().subtract('days',89),moment()],'Last 180 Days':[moment().subtract('days',179),moment()],'Last 12 Months':[moment().subtract('month',12),moment()],'Last 18 Months':[moment().subtract('month',18),moment()]},
                "locale": {
                    "format": "YYYY-MM-DD",
                    "separator": " to ",
                    "applyLabel": "Apply",
                    "cancelLabel": "Cancel",
                    "fromLabel": "From",
                    "toLabel": "To",
                    "customRangeLabel": "Custom",
                    "daysOfWeek": [
                        "Su",
                        "Mo",
                        "Tu",
                        "We",
                        "Th",
                        "Fr",
                        "Sa"
                    ],
                    "monthNames": [
                        "January",
                        "February",
                        "March",
                        "April",
                        "May",
                        "June",
                        "July",
                        "August",
                        "September",
                        "October",
                        "November",
                        "December"
                    ],
                    //"firstDay": 1
                },
                //"startDate": "11/08/2015",
                //"endDate": "11/14/2015",
                opens: "left",
            }, function(start, end, label) {

                $('#dashboard-report-range span').html(start.format('MMMM D, YYYY') + ' to ' + end.format('MMMM D, YYYY'));
                $('#sampleCollectionDate').val(start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
            });
                $('#dashboard-report-range span').html(moment().subtract('days', 179).format('MMMM D, YYYY') + ' to ' + moment().format('MMMM D, YYYY'));
                $('#dashboard-report-range').show();
                
                
                
                getEverything();
                

                //getLabFacilities();
                
                
                
});
            
        function getEverything(){

            if( !$('#sampleCollectionDate').val() ) {
              $('#sampleCollectionDate').val(moment().subtract('days', 179).format('YYYY-MM-DD') + ' to ' + moment().format('YYYY-MM-DD'));
            }
            
            getSampleResult();
            getTestedSampleResult();
            getTestedSampleResultBasedVolume();
            getRequisitionFormsTested();
            getSampleVolume();
            getLabTime();
            getLabFacilities();
        }            
            
            
        </script>
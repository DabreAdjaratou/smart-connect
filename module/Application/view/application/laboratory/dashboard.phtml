<?php
$startYear=date("Y", strtotime("-1 year"));
$startMonth = date('m', strtotime('+1 month', strtotime('-1 year')));

$startDate = date('Y-m', strtotime('+1 month', strtotime('-1 year')));
$endDate=date('Y-m');

?>
<style>
    .bluebox, .dashboard-stat2{
        border:1px solid #3598DC;
    }

.mrp-monthdisplay{
  display:inline-block!important;
  border-radius: 0px 5px 5px 0px;
  
  cursor:pointer;
}

.mrp-lowerMonth, .mrp-upperMonth{
  color: #40667A;
  font-weight:bold;
  font-size: 11px;
  text-transform:uppercase;
}

.mrp-to{
  color: #aaa;
  margin-right: 0px;
  margin-left: 0px;
  font-size: 11px;
  text-transform: uppercase;
  /* background-color: #eee; */
  padding: 5px 3px 5px 3px;
}

.mpr-calendar{
  display:inline-block;
  padding: 3px 5px;
  border-right: solid #999 1px;
}

.mpr-calendar::last-child{
  border-right: none;  
}

.mpr-month{
  padding: 20px;
  text-transform: uppercase;
  font-size: 12px;
}

.mpr-calendar h5{
  width:100%;
  text-align:center;
  font-weight:bold;
  font-size:18px
}

.mpr-selected{
  
}

.mpr-month:hover{
  border-radius: 5px;
  box-shadow: 0 0 0 1px #ddd inset;
  cursor:pointer;
}

.mpr-selected.mpr-month:hover{
  border-radius: 0px;
  box-shadow: none;
}

.mpr-calendarholder .col-xs-6 {
  max-width: 250px;
  min-width: 250px;
}

.mpr-calendarholder .col-xs-1 {
  max-width: 150px;
  min-width: 150px;
}

.mpr-calendarholder .btn-info{
  background-color: #40667A;
  border-color: #406670;
  width:100%;
  margin-bottom: 10px;
  text-transform: uppercase;
  font-size: 10px;
  padding: 10px 0px;
}

.mpr-quickset{
  color: #666;
  text-transform: uppercase;
  text-align: center;
}

.mpr-yeardown, .mpr-yearup{
  margin-left: 5px;
  cursor: pointer;
  color: #666;
}

.mpr-yeardown{
  float:left;
}

.mpr-yearup{
  float:right;
}

.mpr-yeardown:hover,.mpr-yearup:hover{
  color: #40667A;
}

.mpr-calendar:first .mpr-selected:first{
    background-color: #40667A;
}

.mpr-calendar:last .mpr-selected:last{
    background-color: #40667A;
}

.popover{
  max-width: 1920px!important;
}


</style>
<?php
$sType = '';
foreach($sampleType as $samples){
    $sType.='<option value="'.base64_encode($samples['sample_id']).'">'.ucwords($samples['sample_name']).'</option>';
}
?>
                    <!-- BEGIN PAGE BAR -->
                    <!-- BEGIN PAGE BAR -->
                    <div class="page-bar">
                        <ul class="page-breadcrumb">
                            <li>
                                <a href="/">Labs Dashboard</a>
                            </li>
                        </ul>
                    </div>

                    <!-- END PAGE BAR -->
                    <!-- BEGIN PAGE TITLE-->
                    
                    <br>
                    <br>
                    
                    <!-- END PAGE TITLE-->
                    <!-- END PAGE HEADER-->
                    <div class="row" style="padding-top:10px;padding-bottom:20px;">
                        <div class="col-lg-3">
                            <div id="sla-data-range" class="mrp-container form-control">
                                <span class="mrp-icon"><i class="fa fa-calendar"></i> &nbsp;</span>
                                <div class="mrp-monthdisplay ">
                                  <span class="mrp-lowerMonth"><?php echo date('M', strtotime('+1 month', strtotime('-1 year')));; ?> <?php echo $startYear; ?></span>
                                  <span class="mrp-to"> to </span>
                                  <span class="mrp-upperMonth"><?php echo date('M'); ?> <?php echo date('Y'); ?></span>
                                </div>
                              <input type="hidden" value="<?php echo $startDate; ?>" id="mrp-lowerDate" />
                              <input type="hidden" value="<?php echo $endDate; ?>" id="mrp-upperDate" />
                            </div>
                        </div>
                        
                        
                        <div class="col-lg-3">
                            <select name="labName" id="labName" class="form-control" title="Please choose lab name">
                                <option value="">-- Lab Name --</option>
                                <?php
                                foreach($labName as $lab)
                                {
                                    ?>
                                    <option value="<?php echo base64_encode($lab['facility_id']);?>"><?php echo $lab['facility_name'];?></option>
                                    <?php
                                }
                                ?>
                                
                            </select>
                        </div>
                        <div class="col-lg-3">
                                <a href="javascript:void(0);" class="btn btn-info btn-sm" onclick="getEverything()">Submit</a>
                            </div>
                    </div>
                    <div class="row">
                        <div id="sampleResultDetails"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-sm-6">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption ">
                                        <span class="caption-subject">Samples Tested</span>
                                    </div>
                                    <div class="actions">
                                        <div class="btn-group">
                                            <select id="sampleType" class="fetchAll btn white btn-outline btn-circle btn-sm dropdown-toggle">
                                                <option value="">All Sample Types</option>
                                                <?php echo $sType;?>
                                            </select>
                                        </div>
                                    </div>                                    
                                    
                                </div>
                                <div class="portlet-body" style="cursor:pointer;" onclick="document.location.href='/labs/samples-tested'">
                                    <div id="samplesTestedResult"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 col-sm-6">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption ">
                                        <span class="caption-subject">Samples Tested based on Volume</span>
                                    </div>
                                    <div class="actions">
                                        <div class="btn-group">
                                            <select id="sampleTypeVolume" class="fetchAll btn white btn-outline btn-circle btn-sm dropdown-toggle">
                                                <option value="">All Sample Types</option>
                                                <?php echo $sType;?>
                                            </select>
                                        </div>
                                    </div>                                    
                                </div>
                                <div class="portlet-body" style="cursor:pointer;" onclick="document.location.href='/labs/samples-tested'">
                                    <div id="facilitiesTestedValue"></div>
                                </div>
                            </div>
                        </div>                        
                        
                    </div>
                    <div class="row">
                        <div class="col-md-4 col-sm-4">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption ">
                                        <span class="caption-subject">Laboratory Turnaround Time</span>
                                    </div>
                                </div>
                                <div class="portlet-body">
                                    <div id="labAverageTat"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <span class="caption-subject">Requisition Forms for Testing</span>
                                    </div>
                                </div>
                                <div class="portlet-body" id="requisitionForms">
                                    
                                </div>
                            </div>                            
                            
                            
                        </div>
                        <div class="col-md-4 col-sm-4">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <span class="caption-subject">Sample Volume</span>
                                    </div>
                                    <div class="actions">
                                        <div class="btn-group">
                                            <select id="sampleVolume" class="fetchAll btn white btn-outline btn-circle btn-sm dropdown-toggle">
                                                <option value="">All Sample Types</option>
                                                <?php echo $sType;?>
                                            </select>
                                        </div>
                                    </div>                                    
                                </div>
                                <div class="portlet-body" id="pieChartLabResult">
                                </div>
                            </div>                            
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption ">
                                        <span class="caption-subject">Facilities</span>
                                    </div>
                                </div>                                
                                <div class="portlet-body">
                                    <div id="controls-polyline"></div>
                                    <div id="gmap-polyline-data"  ></div>
                                    
                                </div>
                            </div>
                        </div>                        
                    </div>
        
        <script src="https://maps.google.com/maps/api/js?libraries=geometry&v=3&key=AIzaSyAFpbfAKFJZ8Ps7yAGIDZtD4EeBlsb_ANA"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>
        <script src="<?php echo $this->basePath('assets/pages/scripts/dashboard.js'); ?>" type="text/javascript"></script>
        <script src="<?php echo $this->basePath('assets/global/scripts/maplace.min.js'); ?>"></script>
        
        
        <script>
            
            var gfxPath = 'https://raw.githubusercontent.com/highslide-software/pattern-fill/master/graphics/';
            var dpicker = "";
            var startDate;
            var endDate;

            
        function getSampleResult()
        {
            
            fromDate=$('#mrp-lowerDate').val();
            toDate=$('#mrp-upperDate').val();
            facilityId = $("#labName").val();
        $.post("<?php echo $this->url('laboratory', array('action' => 'get-sample-result')); ?>",{fromDate:fromDate,toDate:toDate,facilityId:facilityId},
        function(data) {
            $("#sampleResultDetails").html(data);
        });
        }
        function getTestedSampleResult()
        {
            sampleType = $("#sampleType").val();
            fromDate=$('#mrp-lowerDate').val();
            toDate=$('#mrp-upperDate').val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-sample-test-result')); ?>",{fromDate:fromDate,toDate:toDate,sampleType:sampleType,facilityId:facilityId},
            function(data) {
                $("#samplesTestedResult").html(data);
            });
        }
        function getTestedSampleResultBasedVolume()
        {
            sampleType = $("#sampleTypeVolume").val();
            fromDate=$('#mrp-lowerDate').val();
            toDate=$('#mrp-upperDate').val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-sample-test-result-volume')); ?>",{fromDate:fromDate,toDate:toDate,sampleType:sampleType,facilityId:facilityId,facilityId:facilityId},
            function(data) {
                $("#facilitiesTestedValue").html(data);
            });
        }
        function getRequisitionFormsTested()
        {
            fromDate=$('#mrp-lowerDate').val();
            toDate=$('#mrp-upperDate').val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-requisition-forms')); ?>",{fromDate:fromDate,toDate:toDate,facilityId:facilityId},
            function(data) {
            $("#requisitionForms").html(data);
            });
        }
        function getSampleVolume()
        {
            dateRange = $("#sampleCollectionDate").val();
            sampleType = $("#sampleVolume").val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-sample-volume')); ?>",{sampleCollectionDate:dateRange,sampleType:sampleType,facilityId:facilityId},
            function(data) {
            $("#pieChartLabResult").html(data);
            });
        }
        function getLabTime()
        {
            dateRange = $("#sampleCollectionDate").val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-lab-turn-around-time')); ?>",{sampleCollectionDate:dateRange,facilityId:facilityId},
            function(data) {
            $("#labAverageTat").html(data);
            });
        }
        function getLabFacilities()
        {
            dateRange = $("#sampleCollectionDate").val();
            facilityId = $("#labName").val();
            $.post("<?php echo $this->url('laboratory', array('action' => 'get-lab-facilities')); ?>",{sampleCollectionDate:dateRange,facilityId:facilityId},
            function(data) {
            $("#gmap-polyline-data").html(data);
            });
        }
            
            $(function () {
                
                $.blockUI.defaults.css.border = '1px solid grey'; 
                $(document).ajaxStart($.blockUI({ message: '<h2>Processing...</h2>' })).ajaxStop($.unblockUI);
                

                $(".fetchAll").on("change", function(){
                    getEverything();
                });
                
                getEverything();    
});
            
        function getEverything(){

            if( !$('#sampleCollectionDate').val() ) {
              $('#sampleCollectionDate').val(moment().subtract('days', 179).format('YYYY-MM-DD') + ' to ' + moment().format('YYYY-MM-DD'));
            }
            
            getSampleResult();
            getTestedSampleResult();
            getTestedSampleResultBasedVolume();
            getRequisitionFormsTested();
            getSampleVolume();
            getLabTime();
            getLabFacilities();
        }            
            
        var MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

$(function () {
  startMonth = <?php echo $startMonth; ?>;
  startYear = <?php echo $startYear; ?>;
  endMonth = 4;
  endYear = 2017;
  fiscalMonth = 7;
  if(startMonth < 10)
  	startDate = parseInt("" + startYear + '0' + startMonth + "");
  else
    startDate = parseInt("" + startYear  + startMonth + "");
  if(endMonth < 10)
  	endDate = parseInt("" + endYear + '0' + endMonth + "");
  else
    endDate = parseInt("" + endYear + endMonth + "");
  
  content = '<div class="row mpr-calendarholder">';
  calendarCount = endYear - startYear;
  if(calendarCount == 0)
    calendarCount++;
  var d = new Date();
  for(y = 0; y < 2; y++){
		content += '<div class="col-xs-6" ><div class="mpr-calendar row" id="mpr-calendar-' + (y+1) + '">'
 						 + '<h5 class="col-xs-12"><i class="mpr-yeardown fa fa-chevron-circle-left"></i><span>' + (startYear + y).toString() + '</span><i class="mpr-yearup fa fa-chevron-circle-right"></i></h5><div class="mpr-monthsContainer"><div class="mpr-MonthsWrapper">';
    for(m=0; m < 12; m++){
      var monthval;
      if((m+1) < 10)
        monthval = "0" + (m+1);
      else
        monthval = "" + (m+1);
			content += '<span data-month="' + monthval  + '" class="col-xs-3 mpr-month">' + MONTHS[m] + '</span>';
    }
    content += '</div></div></div></div>';
  }
  content += '<div class="col-xs-1">';
  //content += '<button class="btn btn-info mpr-fiscal-ytd">Fiscal YTD</button>';
  //content += '<button class="btn btn-info mpr-ytd">YTD</button>';
  //content += '<button class="btn btn-info mpr-prev-fiscal">Previous FY</button>';
  //content += '<button class="btn btn-info mpr-prev-year">Previous Year</button>';
  content += '<button class="btn btn-info mpr-close">Apply</button>';
  content += '</div>';
  content += '</div>';
  
  $(document).on('click','.mpr-month',function(e){
    e.stopPropagation();
  		$month = $(this);
    	var monthnum = $month.data('month');
    	var year = $month.parents('.mpr-calendar').children('h5').children('span').html();
        if($month.parents('#mpr-calendar-1').size() > 0){
          //Start Date
          startDate = parseInt("" + year + monthnum);
          if(startDate > endDate){
            
            if(year != parseInt(endDate/100))
              $('.mpr-calendar:last h5 span').html(year);
               endDate = startDate;
          }
        }else{
          //End Date
          endDate = parseInt("" + year + monthnum);
          if(startDate > endDate){
            if(year != parseInt(startDate/100))
              $('.mpr-calendar:first h5 span').html(year);
            startDate = endDate;
          }
        }
    
    	paintMonths();
  });
  
  
  $(document).on('click','.mpr-yearup',function(e){
        $('.mpr-month').css("color","black");
    	e.stopPropagation();
  		var year = parseInt($(this).prev().html());
    	year++;
    	$(this).prev().html(""+year);
   	 	$(this).parents('.mpr-calendar').find('.mpr-MonthsWrapper').fadeOut(175,function(){
        paintMonths();
        $(this).parents('.mpr-calendar').find('.mpr-MonthsWrapper').fadeIn(175);
      });
  });
  
  $(document).on('click','.mpr-yeardown',function(e){
        $('.mpr-month').css("color","black");
    	e.stopPropagation();
  		var year = parseInt($(this).next().html());
    	year--;
    	$(this).next().html(""+year);
   	 	//paintMonths();
      $(this).parents('.mpr-calendar').find('.mpr-MonthsWrapper').fadeOut(175,function(){
        paintMonths();
        $(this).parents('.mpr-calendar').find('.mpr-MonthsWrapper').fadeIn(175);
      });
  });
  
  $(document).on('click','.mpr-ytd', function(e){
    e.stopPropagation();
    var d = new Date();
    startDate = parseInt(d.getFullYear() + "01");
    var month = d.getMonth() + 1;
    if(month < 9)
      month = "0" + month;
    endDate = parseInt("" + d.getFullYear() + month);
    $('.mpr-calendar').each(function(){
      var $cal = $(this);
      var year = $('h5 span',$cal).html(d.getFullYear());
    });
    $('.mpr-calendar').find('.mpr-MonthsWrapper').fadeOut(175,function(){
        paintMonths();
        $('.mpr-calendar').find('.mpr-MonthsWrapper').fadeIn(175);
    });
  });
  
  $(document).on('click','.mpr-prev-year', function(e){
    e.stopPropagation();
    var d = new Date();
    var year = d.getFullYear()-1;
    startDate = parseInt(year + "01");
    endDate = parseInt(year + "12");
    $('.mpr-calendar').each(function(){
      var $cal = $(this);
      $('h5 span',$cal).html(year);
    });
    $('.mpr-calendar').find('.mpr-MonthsWrapper').fadeOut(175,function(){
        paintMonths();
        $('.mpr-calendar').find('.mpr-MonthsWrapper').fadeIn(175);
    });
  });
  
  $(document).on('click','.mpr-fiscal-ytd', function(e){
    e.stopPropagation();
    var d = new Date();
    var year;
    if((d.getMonth()+1) < fiscalMonth)
      year = d.getFullYear() - 1;
    else
      year = d.getFullYear();
    if(fiscalMonth < 10)
      fm = "0" + fiscalMonth;
    else
      fm = fiscalMonth;
    if(d.getMonth()+1 < 10)
      cm = "0" + (d.getMonth()+1);
    else
      cm = (d.getMonth()+1);
    startDate = parseInt("" + year + fm);
    endDate = parseInt("" + d.getFullYear() + cm);
    $('.mpr-calendar').each(function(i){
      var $cal = $(this);
      if(i == 0)
      	$('h5 span',$cal).html(year);
      else
        $('h5 span',$cal).html(d.getFullYear());
    });
    $('.mpr-calendar').find('.mpr-MonthsWrapper').fadeOut(175,function(){
        paintMonths();
        $('.mpr-calendar').find('.mpr-MonthsWrapper').fadeIn(175);
    });
  });
  
  $(document).on('click','.mpr-prev-fiscal', function(){
    var d = new Date();
    var year;
    if((d.getMonth()+1) < fiscalMonth)
      year = d.getFullYear() - 2;
    else
      year = d.getFullYear() - 1;
    if(fiscalMonth < 10)
      fm = "0" + fiscalMonth;
    else
      fm = fiscalMonth;
    if(fiscalMonth -1 < 10)
      efm = "0" + (fiscalMonth-1);
    else
      efm = (fiscalMonth-1);
    startDate = parseInt("" + year + fm);
    endDate = parseInt("" + (d.getFullYear() - 1) + efm);
    $('.mpr-calendar').each(function(i){
      var $cal = $(this);
      if(i == 0)
      	$('h5 span',$cal).html(year);
      else
        $('h5 span',$cal).html(d.getFullYear()-1);
    });
    $('.mpr-calendar').find('.mpr-MonthsWrapper').fadeOut(175,function(){
        paintMonths();
        $('.mpr-calendar').find('.mpr-MonthsWrapper').fadeIn(175);
    });
  });
  
  var mprVisible = false;
  var mprpopover = $('.mrp-container').popover({
    container: "body",
    placement: "bottom",
    html: true,
    content: content
  }).on('show.bs.popover', function () {
    $('.popover').remove();
    var waiter = setInterval(function(){
      if($('.popover').size() > 0){
        clearInterval(waiter);
        setViewToCurrentYears();
    		paintMonths();
      }
    },50);
  }).on('shown.bs.popover', function(){
    mprVisible = true;
  }).on('hidden.bs.popover', function(){
    mprVisible = false;
  }); 
  
  $(document).on('click','.mpr-calendarholder',function(e){
    e.preventDefault();
    e.stopPropagation();
  });
  $(document).on("click",".mrp-container",function(e){
    if(mprVisible){
      e.preventDefault();
    	e.stopPropagation();
      mprVisible = false;
    }
  });
  
  $(document).on("click",function(e){
   
    if(mprVisible){
    	$('.mpr-calendarholder').parents('.popover').fadeOut(200,function(){
        $('.mpr-calendarholder').parents('.popover').remove();
        $('.mrp-container').trigger('click');
      });
      mprVisible = false;
    }
  });
  
  $(document).on('click','.mpr-close', function(e){
    //console.log(e);
    if(mprVisible){
    	$('.mpr-calendarholder').parents('.popover').fadeOut(200,function(){
        $('.mpr-calendarholder').parents('.popover').remove();
        $('.mrp-container').trigger('click');
      });
      mprVisible = false;
    }
  });
  
});

function setViewToCurrentYears(){
  	var startyear = parseInt(startDate / 100);
    var endyear = parseInt(endDate / 100);
  	$('.mpr-calendar h5 span').eq(0).html(startyear);
  	$('.mpr-calendar h5 span').eq(1).html(endyear);
}

function paintMonths(){
    $('.mpr-calendar').each(function(){
      var $cal = $(this);
      var year = $('h5 span',$cal).html();
      $('.mpr-month',$cal).each(function(i){
        if((i+1) > 9)
          cDate = parseInt("" + year + (i+1));
        else
          cDate = parseInt("" + year+ '0' + (i+1));
        if(cDate >= startDate && cDate <= endDate){
            $(this).addClass('mpr-selected');
        }else{
          $(this).removeClass('mpr-selected');
        }
      });
    });
    
  $('.mpr-calendar .mpr-month').css("background","");
    //Write Text
    var startyear = parseInt(startDate / 100);
    var startmonth = parseInt(safeRound((startDate / 100 - startyear)) * 100);
    var endyear = parseInt(endDate / 100);
    var endmonth = parseInt(safeRound((endDate / 100 - endyear)) * 100);
    $('.mrp-monthdisplay .mrp-lowerMonth').html(MONTHS[startmonth - 1] + " " + startyear);
    $('.mrp-monthdisplay .mrp-upperMonth').html(MONTHS[endmonth - 1] + " " + endyear);
    //$('#mrp-lowerDate').val(startDate);
    //$('#mrp-upperDate').val(endDate);
    
    if(startmonth < 10)
  	startmonth = '0' +startmonth;
    else
    startmonth = startmonth;
    
    if(endmonth < 10){
    endmonth = '0' +endmonth;    
    }
    else{
    endmonth = endmonth;    
    }
     $('#mrp-lowerDate').val(startyear+' - '+startmonth);
    $('#mrp-upperDate').val(endyear+' - '+endmonth);
   
    
  	if(startyear == parseInt($('.mpr-calendar:first h5 span').html()))
  		//$('.mpr-calendar:first .mpr-selected:first').css("background","#40667A");
        
         $('.mpr-month').css("color","black");
    if(endyear == parseInt($('.mpr-calendar:last h5 span').html()))
      //$('.mpr-calendar:last .mpr-selected:last').css("background","#40667A");
      $('.mpr-month').css("color","black");
      $('.mpr-calendar:first .mpr-selected:first').css({"background-color": "#40667A","color":"#fff"});
      $('.mpr-calendar:last .mpr-selected:last').css({"background-color": "#40667A","color":"#fff"});
      
  }

  function safeRound(val){
    return Math.round(((val)+ 0.00001) * 100) / 100;
  }
  
  
        </script>